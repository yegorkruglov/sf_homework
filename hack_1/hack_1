import UIKit


// Абстракция данных пользователя
protocol UserData {
  var userName: String { get }    //Имя пользователя
  var userCardId: String { get }   //Номер карты
  var userCardPin: Int { get }       //Пин-код
  var userPhone: String { get }       //Номер телефона
  var userCash: Float { get set }   //Наличные пользователя
  var userBankDeposit: Float { get set }   //Банковский депозит
  var userPhoneBalance: Float { get set }    //Баланс телефона
  var userCardBalance: Float { get set }    //Баланс карты
}

struct User: UserData {
    var userName: String
    
    var userCardId: String
    
    var userCardPin: Int
    
    var userPhone: String
    
    var userCash: Float
    
    var userBankDeposit: Float
    
    var userPhoneBalance: Float
    
    var userCardBalance: Float
}
 
let ivanIvanov: UserData = User(
    userName: "Ivan Ivanov",
    userCardId: "1234 1234 1234 1234",
    userCardPin: 1234,
    userPhone: "+7(123)-123-12-12",
    userCash: 5000,
    userBankDeposit: 10000,
    userPhoneBalance: -100,
    userCardBalance: 3000)

// Действия, которые пользователь может выбирать в банкомате (имитация кнопок)
enum UserActions {
    case userPressedBalanceButtonCard
    case userPressedBalanceButtonDeposit
    case userPressedWithdrawCashCard (withdrawCash: Float)
    case userPressedWithdrawCashDeposit (withdrawCash: Float)
    case userPressedTopUpCard (topUp: Float)
    case userPressedTopUpDeposit (topUp: Float)
    case userPressedPayPhone(phone: String)
}
 

// Виды операций, выбранных пользователем (подтверждение выбора)
enum DescriptionTypesAvailableOperations: String {
    case userPressedBalanceButtonCard = "Вы выбрали операцию запросить баланс по карте"
    case userPressedBalanceButtonDeposit = "Вы выбрали операцию запросить баланс на депозите"
    case userPressedWithdrawCashCard = "Вы выбрали операцию снятие наличных с карты"
    case userPressedWithdrawCashDeposit = "Вы выбрали операцию снятие наличных с депозита"
    case userPressedTopUpCard = "Вы выбрали оперциюб пополнение карты"
    case userPressedTopUpDeposit = "Вы выбрали оперциюб пополнение депозита"
    case userPressedPayPhone = "Вы выбрали операцию пополнить баланс телефона"
}

// Способ оплаты/пополнения наличными, картой или через депозит
enum PaymentMethod {
    case cash(cash: Float)
    case card(card: Float)
}


// Тексты ошибок
enum TextErrors: String {
    case cardNumberOrPinIncorrect = "Данные карты или пинкод введены неверно"
    case enteredIncorrectPhoneNumber = "Введен неверный номер телефона"
    case youDontHAveEnooughCash = "У вас недостаточно наличных"
    case youDontHaveEnoughFindsCard = "У вас недостаточно средств на карте"
    case youDontHaveEnoughFindsDeposit = "У вас недостаточно средств на депозите"
}


// Протокол по работе с банком предоставляет доступ к данным пользователя зарегистрированного в банке
protocol BankApi {
    func showUserCardBalance()
    func showUserDepositBalance()
    func showUserToppedUpMobilePhoneCash(cash: Float)
    func showUserToppedUpMobilePhoneCard(card: Float)
    func showWithdrawalCard(cash: Float)
    func showWithdrawalDeposit(cash: Float)
    func showTopUpCard(cash: Float)
    func showTopUpDeposit(cash: Float)
    func showError(error: TextErrors)
 
    func checkUserPhone(phone: String) -> Bool
    func checkMaxUserCash(cash: Float) -> Bool
    func checkMaxUserCard(withdraw: Float) -> Bool
    func checkMaxUserDeposit(withdraw: Float) -> Bool
    func checkCurrentUser(userCardId: String, userCardPin: Int) -> Bool
 
    mutating func topUpPhoneBalanceCash(pay: Float)
    mutating func topUpPhoneBalanceCard(pay: Float)
    mutating func getCashFromDeposit(cash: Float)
    mutating func getCashFromCard(cash: Float)
    mutating func putCashDeposit(topUp: Float)
    mutating func putCashCard(topUp: Float)
}

struct BankServer: BankApi {
    private var user: UserData
    
    init(user: UserData) {
        self.user = user
    }
    
    func showUserCardBalance() {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedBalanceButtonCard.rawValue)
        Ваш баланс по карте составляет: \(user.userCardBalance) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showUserDepositBalance() {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedBalanceButtonDeposit.rawValue)
        Ваш баланс по депозиту составляет: \(user.userBankDeposit) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showUserToppedUpMobilePhoneCash(cash: Float) {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedPayPhone.rawValue)
        Вы пополнили баланс телефона на сумму: \(cash)
        У вас осталось \(user.userCash) рублей наличными
        Баланс Вашего телефона составляет: \(user.userPhoneBalance) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showUserToppedUpMobilePhoneCard(card: Float) {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedPayPhone.rawValue)
        Вы пополнили баланс телефона на сумму: \(card)
        У вас осталось \(user.userCardBalance) рублей на счету карты
        Баланс Вашего телефона составляет: \(user.userPhoneBalance) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showWithdrawalCard(cash: Float) {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedWithdrawCashCard.rawValue)
        Вы сняли с карты средства на сумму: \(cash)
        У вас осталось на карте: \(user.userCardBalance) рублей
        У вас осталось наличных: \(user.userCash) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showWithdrawalDeposit(cash: Float) {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedWithdrawCashDeposit.rawValue)
        Вы сняли с депозита средства на сумму: \(cash)
        У вас осталось на депозите: \(user.userBankDeposit) рублей
        У вас осталось наличных: \(user.userCash) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showTopUpCard(cash: Float) {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedTopUpCard.rawValue)
        Вы пополнили баланс карты на сумму: \(cash)
        Баланс карты составляет: \(user.userCardBalance) рублей
        У вас осталось наличных: \(user.userCash) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showTopUpDeposit(cash: Float) {
        let report = """
        Здравсствуйте, \(user.userName)
        \(DescriptionTypesAvailableOperations.userPressedTopUpDeposit.rawValue)
        Вы пополнили баланс депозита на сумму: \(cash)
        Баланс депозита составляет: \(user.userBankDeposit) рублей
        У вас осталось наличных: \(user.userCash) рублей
        Хорошего дня!
        """
        print(report)
    }
    
    func showError(error: TextErrors) {
        let report = """
        Здравсствуйте, \(user.userName)
        Ошибка: \(error.rawValue)
        Хорошего дня!
        """
        print(report)
    }
    
    func checkUserPhone(phone: String) -> Bool {
        if phone == user.userPhone {
            return true
        }
        return false
    }
    
    func checkMaxUserCash(cash: Float) -> Bool {
        if cash <= user.userCash {
            return true
        }
        return false
    }
    
    func checkMaxUserCard(withdraw: Float) -> Bool {
        if withdraw <= user.userCardBalance {
            return true
        }
        return false
    }
    
    func checkMaxUserDeposit(withdraw: Float) -> Bool {
        if withdraw <= user.userBankDeposit {
            return true
        }
        return false
    }
    
    func checkCurrentUser(userCardId: String, userCardPin: Int) -> Bool {
        if (userCardId == user.userCardId) && (userCardPin == user.userCardPin) {
            return true
        }
        return false
    }
    
    mutating func topUpPhoneBalanceCash(pay: Float) {
        user.userPhoneBalance += pay
        user.userCash -= pay
    }
    
    mutating func topUpPhoneBalanceCard(pay: Float) {
        user.userPhoneBalance += pay
        user.userCardBalance -= pay
    }
    
    mutating func getCashFromDeposit(cash: Float) {
        user.userBankDeposit -= cash
        user.userCash += cash
    }
    
    mutating func getCashFromCard(cash: Float) {
        user.userCardBalance -= cash
        user.userCash += cash
    }
    
    mutating func putCashDeposit(topUp: Float) {
        user.userBankDeposit += topUp
        user.userCash -= topUp
    }
    
    mutating func putCashCard(topUp: Float) {
        user.userCardBalance += topUp
        user.userCash -= topUp
    }
}

class ATM {
    private let userCardId: String
    private let userCardPin: Int
    private var someBank: BankApi
    private let action: UserActions
    private let paymentMethod: PaymentMethod?
 
    init(userCardId: String, userCardPin: Int, someBank: BankApi, action: UserActions, paymentMethod: PaymentMethod? = nil) {
        
        self.userCardId = userCardId
        self.userCardPin = userCardPin
        self.someBank = someBank
        self.action = action
        self.paymentMethod = paymentMethod
 
 
    sendUserDataToBank(userCardId: userCardId, userCardPin: userCardPin, actions: action, payment: paymentMethod)
  }
 
 
    public final func sendUserDataToBank(userCardId: String, userCardPin: Int, actions: UserActions, payment: PaymentMethod?) {
        let isUserExist = someBank.checkCurrentUser(userCardId: userCardId, userCardPin: userCardPin)
        if isUserExist {
            switch actions{
            case .userPressedBalanceButtonCard:
                someBank.showUserCardBalance()
            case .userPressedBalanceButtonDeposit:
                someBank.showUserDepositBalance()
            case let .userPressedWithdrawCashCard(withdrawCash):
                if someBank.checkMaxUserCard(withdraw: withdrawCash) {
                    someBank.getCashFromCard(cash: withdrawCash)
                    someBank.showWithdrawalCard(cash: withdrawCash)
                } else {
                    someBank.showError(error: .youDontHaveEnoughFindsCard)
                }
            case let .userPressedWithdrawCashDeposit(withdrawCash):
                if someBank.checkMaxUserDeposit(withdraw: withdrawCash) {
                    someBank.getCashFromDeposit(cash: withdrawCash)
                    someBank.showWithdrawalDeposit(cash: withdrawCash)
                }
            case let .userPressedTopUpCard(topUp: payment):
                if someBank.checkMaxUserCash(cash: payment) {
                    someBank.putCashCard(topUp: payment)
                    someBank.showTopUpCard(cash: payment)
                } else {
                    someBank.showError(error: .youDontHAveEnooughCash)
                }
            case let .userPressedTopUpDeposit(topUp: payment):
                if someBank.checkMaxUserCash(cash: payment) {
                    someBank.putCashDeposit(topUp: payment)
                    someBank.showTopUpDeposit(cash: payment)
                }
            case let .userPressedPayPhone(phone):
                if someBank.checkUserPhone(phone: phone) {
                    if let payment = payment {
                        switch payment {
                        case let .cash(cash: payment):
                            if someBank.checkMaxUserCash(cash: payment) {
                                someBank.topUpPhoneBalanceCash(pay: payment)
                                someBank.showUserToppedUpMobilePhoneCash(cash: payment)
                            } else {
                                someBank.showError(error: .youDontHAveEnooughCash)
                            }
                        case let .card(card: payment):
                            if someBank.checkMaxUserCard(withdraw: payment) {
                                someBank.topUpPhoneBalanceCard(pay: payment)
                                someBank.showUserToppedUpMobilePhoneCard(card: payment)
                            } else {
                                someBank.showError(error: .youDontHaveEnoughFindsCard)
                            }
                        }
                    }
                } else {
                    someBank.showError(error: .enteredIncorrectPhoneNumber)
                }
            }
        } else {
            someBank.showError(error: .cardNumberOrPinIncorrect)
        }
    }
}

let bankClient = BankServer(user: ivanIvanov)

let atm123 = ATM(
    userCardId: "1234 1234 1234 1234",
    userCardPin: 1234,
    someBank: bankClient,
    action: .userPressedTopUpCard(topUp: 39gi00),
    paymentMethod: .cash(cash: 9000)
)
